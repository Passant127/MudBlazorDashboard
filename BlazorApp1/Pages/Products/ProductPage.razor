@page "/products"

@using System.Net.Http.Json
@using System.Threading
@using Bogus
@using Dashboard.Application.Contracts
@using Dashboard.Application.DTOS.ProductDtos
@using Dashboard.Application.SearchingCriteria
@using Dashboard.Application.SearchingCriteria.ProductSearchCriteria
@using Dashboard.Application.Services
@using Dashboard.Application.Sorting
@using Dashboard.Core.Entities
@using Dashboard.Domain.Entities
@using System.Diagnostics
@using StackExchange.Profiling
@inject IProductService _productService
@inject ISortingService _sortingService

<h3>ProductPage</h3>

<MudButton OnClick="AddItem" Color="Color.Success" Class="add-item-btn">Add Product</MudButton>
<MudButton OnClick="RemoveItem" Color="Color.Error" Class="remove-item-btn">Remove Product</MudButton>

<h5>Searching Criteria</h5>

<MudGrid class="ml-2 my-5">
    <MudTextField @bind-Value="productSearch.ProductName" OnBlur="GetSearchedItemsFromServer" Label="Product Name" Variant="Variant.Text"></MudTextField>
    <MudTextField @bind-Value="productSearch.ProductDescription" OnBlur="GetSearchedItemsFromServer" Label="Product Description" Variant="Variant.Text"></MudTextField>
    <MudTextField @bind-Value="productSearch.BrandName" OnBlur="GetSearchedItemsFromServer" Label="Product Brand" Variant="Variant.Text"></MudTextField>
    <MudTextField @bind-Value="productSearch.CategoryName" OnBlur="GetSearchedItemsFromServer" Label="Product Category" Variant="Variant.Text"></MudTextField>
    <MudTextField @bind-Value="productSearch.VendorName" OnBlur="GetSearchedItemsFromServer" Label="Vendor Name" Variant="Variant.Text"></MudTextField>
</MudGrid>

<MudDataGrid Items="@_items" T="ProductResponseDto" RowsPerPage="@ItemsPerPage" SortChanged="OnSortChanged">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Products</MudText>
        <MudSpacer />
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x => x.Id" Title="ID" />
        <PropertyColumn Property="x => x.Name" Title="Name" />
        <PropertyColumn Property="x => x.Description" Title="Description" />
        <PropertyColumn Property="x => x.Price" Title="Price" />
        <PropertyColumn Property="x => x.BrandName" Title="Brand" />
        <PropertyColumn Property="x => x.CategoryName" Title="Category" />
        <PropertyColumn Property="x => x.VendorName" Title="Vendor" />
    </Columns>
    <PagerContent>
        <MudPagination SelectedChanged="PaginationChanged" Count="@((_totalItemCount + ItemsPerPage - 1) / ItemsPerPage)" Class="pa-4" />
        <MudSelect T="int" @bind-Value="ItemsPerPage" Label="Items Per Page" Variant="Variant.Text" SelectedValueChanged="ChangeItemPerPage">
            <MudSelectItem Value="10">10</MudSelectItem>
            <MudSelectItem Value="25">25</MudSelectItem>
            <MudSelectItem Value="50">50</MudSelectItem>
            <MudSelectItem Value="75">75</MudSelectItem>
            <MudSelectItem Value="100">100</MudSelectItem>
        </MudSelect>
    </PagerContent>
</MudDataGrid>

@code {
    private List<ProductResponseDto> _items = new List<ProductResponseDto>();
    private ProductSearchCriteria productSearch = new ProductSearchCriteria();
    private int CurrentPage = 1;
    private int ItemsPerPage = 10;
    private int _totalItemCount = 0;
    private ICollection<MudBlazor.SortDefinition<ProductResponseDto>> _sortDefinitions;

    protected override async Task OnInitializedAsync()
    {
        await LoadProductsAsync(CurrentPage, ItemsPerPage, _sortDefinitions);
    }

    private async Task LoadProductsAsync(int page, int itemsInPage, ICollection<MudBlazor.SortDefinition<ProductResponseDto>> sortDefinitions  )
    {
        Stopwatch stopwatch = new Stopwatch();
        stopwatch.Start();

        if (string.IsNullOrEmpty(productSearch.ProductName) &&
            string.IsNullOrEmpty(productSearch.ProductDescription) &&
            string.IsNullOrEmpty(productSearch.BrandName) &&
            string.IsNullOrEmpty(productSearch.CategoryName) &&
            string.IsNullOrEmpty(productSearch.VendorName))
        {
            _items = await _productService.GetAllProductsAsync(page - 1, itemsInPage, ConvertSortDefinitions(_sortDefinitions));
            using (MiniProfiler.Current.Step("Get products count"))
            {
                _totalItemCount = await _productService.GetProductsCount();
            }
        }
        else
        {
            var returnedValues = await _productService.SearchOnProductAsync(productSearch, page - 1, itemsInPage, ConvertSortDefinitions(_sortDefinitions));
            _totalItemCount = returnedValues.Item2;
            _items = returnedValues.Item1;
        }


        stopwatch.Stop();
        double elapsedSeconds = stopwatch.Elapsed.TotalSeconds;
        Console.WriteLine($"Elapsed Time: {elapsedSeconds}s");

        StateHasChanged();
    }

    private async Task PaginationChanged(int pageNumber)
    {
        CurrentPage = pageNumber;
        await LoadProductsAsync(CurrentPage, ItemsPerPage, _sortDefinitions);
    }

    private async Task ChangeItemPerPage(int newItemsPerPage)
    {
        ItemsPerPage = newItemsPerPage;
        CurrentPage = 1;
        await LoadProductsAsync(CurrentPage, ItemsPerPage, _sortDefinitions);
    }

    private async Task GetSearchedItemsFromServer()
    {
        await LoadProductsAsync(CurrentPage, ItemsPerPage, _sortDefinitions);
    }

    private async Task AddItem()
    {
        Guid brandidd = new Guid("69b6146f-9ec5-4497-adb6-08dcb6f7ea04");
        Guid categoryId = new Guid("6be35188-ad0a-4920-dd8b-08dcb6f7e0aa");
        Guid vendorId = new Guid("efb79dd6-fead-4e6f-f6bd-08dcb6f7e39d");
        var faker = new Faker<ProductRequestDto>()
                .RuleFor(r => r.Name, f => f.Random.Word())
                .RuleFor(r => r.Description, f => f.Lorem.Sentence())
                .RuleFor(r => r.Price, f => f.Random.UShort())
                .RuleFor(r => r.BrandId, f => brandidd)
                .RuleFor(r => r.CategoryId, f => categoryId)
                .RuleFor(r => r.VendorId, f => vendorId);

        var records = faker.Generate(150000);
        await _productService.AddProductAsync(records);
        await LoadProductsAsync(CurrentPage, ItemsPerPage, _sortDefinitions);
    }

    private async Task RemoveItem()
    {
        if (_items.Any())
        {
            var productToRemove = _items.First();
            await _productService.DeleteProductAsync(productToRemove.Id);
            await LoadProductsAsync(CurrentPage, ItemsPerPage, _sortDefinitions);
        }
    }

    private async void OnSortChanged(ICollection<MudBlazor.SortDefinition<ProductResponseDto>> sortDefinitions)
    {
        _sortDefinitions = sortDefinitions;
        await LoadProductsAsync(CurrentPage, ItemsPerPage, _sortDefinitions);
    }

    public static List<SortingDefinition> ConvertSortDefinitions(ICollection<MudBlazor.SortDefinition<ProductResponseDto>> mudSortDefinitions)
    {
        if (mudSortDefinitions == null || !mudSortDefinitions.Any())
        {
            return new List<SortingDefinition>();
        }
        return mudSortDefinitions.Select(mudSortDef => new SortingDefinition
            {
                SortBy = mudSortDef.SortBy,
                IsDescending = mudSortDef.Descending
            }).ToList();
    }
}
